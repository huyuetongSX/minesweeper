$(function(){var column,row,mineL,surplus;var mine_sweeper=$("#minesweeper-wrap");var matrix=[];var game_start=false;var _time;init();function init(){$("#create").on("click",create);$("#play").on("click",play)}function create(){if($("#minesweeper")){$("#minesweeper").remove()}$("#start-game").show();column=$("#column").val()?parseInt($("#column").val()):10;row=$("#row").val()?parseInt($("#row").val()):10;mineL=$("#minelength").val()?parseInt($("#minelength").val()):10;surplus=column*row;surplus_html(true);var mine_html="<div class='minesweeper' id='minesweeper' style='column-count:"+column+"'>";for(var i=0,iL=column*row;i<iL;i+=1){mine_html+="<span></span>"}mine_html+="</div>";mine_sweeper.append(mine_html);time(true)}function play(){game_start=true;matrix=[];for(var i=0;i<mineL;i+=1){create_mine(matrix,column,row)}$("#start-game").hide();$("#minesweeper").on("click","span",m_click);$("#minesweeper").on("contextmenu","span",mark);time()}function create_mine(arr,mx,my){var coordinate=Math.floor(Math.random()*(mx*my));if(arr.indexOf(coordinate)!=-1){create_mine(arr,mx,my)}else{arr.push(coordinate)}}function mine_show(arr,a){for(var i=0;i<matrix.length;i+=1){$("#minesweeper span").eq(matrix[i]).html("*");if(a){$("#minesweeper span").eq(matrix[i]).addClass("open")}}}function surplus_html(start){if(!start){surplus-=1}$("#surplus").html(surplus);if(surplus==mineL){game_start=false;alert("游戏结束！你赢了");time(true)}}function time(a){if(!a){clearInterval(_time);$("#time").html("0:0:0");var start=new Date().getTime();_time=setInterval(function(){var now=new Date().getTime()-start;$("#time").html(Math.floor(now/1000/60/60)+":"+Math.floor(now/1000/60%60)+":"+Math.floor(now/1000%60))},500)}else{clearInterval(_time)}}function mark(){if(!$(this).hasClass("mark")&&!$(this).hasClass("open")){$(this).addClass("mark")}else{$(this).removeClass("mark")}return false}function m_click(a){if(!game_start){return false};var _this;if(typeof a=="number"){_this=a}else{_this=$(this).index();if($(this).hasClass("open")||$(this).hasClass("mark")){return false}if(matrix.indexOf(_this)!=-1){mine_show(matrix,true);game_start=false;alert("游戏结束！你输了");time(true);return false}}var adjacent_box=[];var _this_in=0;if(_this>=row){this_up(_this-row-1);adjacent_box.push(_this-row);this_down(_this-row+1)}else{}this_up(_this-1);this_down(_this+1);if(_this<(column*row)-row){this_up(_this+row-1);adjacent_box.push(_this+row);this_down(_this+row+1)}else{}for(var i=0,iL=adjacent_box.length;i<iL;i+=1){if(matrix.indexOf(adjacent_box[i])!=-1){_this_in+=1}}if(_this_in>0){$("#minesweeper span").eq(_this).html(_this_in).addClass("open").removeClass("mark")}else{$("#minesweeper span").eq(_this).addClass("open").removeClass("mark");for(var i=0,iL=adjacent_box.length;i<iL;i+=1){if(!$("#minesweeper span").eq(adjacent_box[i]).hasClass("open")){m_click(adjacent_box[i])}}}surplus_html();function this_up(a){if((_this-1)%row<row-1&&(_this-1)%row>=0){adjacent_box.push(a)}else{}}function this_down(a){if((_this+1)%row<=row-1&&(_this+1)%row>0){adjacent_box.push(a)}else{}}}});